name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, ci-cd ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Backend Tests
  backend-tests:
    name: Backend Tests (.NET)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Restore Server dependencies
      run: dotnet restore
      working-directory: ./Server
    
    - name: Restore Tests dependencies
      run: dotnet restore
      working-directory: ./Server.Tests
    
    - name: Build Server
      run: dotnet build --no-restore --configuration Release
      working-directory: ./Server
    
    - name: Build Tests
      run: dotnet build --no-restore --configuration Release
      working-directory: ./Server.Tests
    
    - name: Run Authentication Tests
      run: dotnet test --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx"
      working-directory: ./Server.Tests
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-test-results
        path: ./Server.Tests/TestResults/test-results.trx

  # Frontend Tests
  frontend-tests:
    name: Frontend Tests (Vitest)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ./Client/package-lock.json
    
    - name: Install dependencies
      run: npm ci
      working-directory: ./Client
    
    - name: Run CheckoutForm Tests
      run: npm test -- CheckoutForm.test.tsx
      working-directory: ./Client
    
    - name: Run All Tests with Coverage
      run: npm run test:coverage
      working-directory: ./Client
      continue-on-error: true
    
    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage
        path: ./Client/coverage

  # Build Check
  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ./Client/package-lock.json
    
    - name: Build Backend (Release)
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
      working-directory: ./Server
    
    - name: Build Frontend (Production)
      run: |
        npm ci
        npm run build
      working-directory: ./Client
    
    - name: Verify Backend Build Artifacts
      run: |
        echo "Checking backend build output..."
        ls -la ./Server/bin/Release/
    
    - name: Verify Frontend Build Artifacts
      run: |
        echo "Checking frontend build output..."
        ls -la ./Client/build/

  # Test Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, build-check]
    if: always()
    
    steps:
    - name: Download Backend Test Results
      uses: actions/download-artifact@v4
      with:
        name: backend-test-results
        path: ./test-results/backend
      continue-on-error: true
    
    - name: Download Frontend Coverage
      uses: actions/download-artifact@v4
      with:
        name: frontend-coverage
        path: ./test-results/frontend
      continue-on-error: true
    
    - name: Display Summary
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ Backend Authentication Tests: Completed" >> $GITHUB_STEP_SUMMARY
        echo "✅ Frontend CheckoutForm Tests: Completed" >> $GITHUB_STEP_SUMMARY
        echo "✅ Build Verification: Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "View detailed results in the job artifacts above." >> $GITHUB_STEP_SUMMARY

  # Optional: Auto-merge dependabot PRs if tests pass
  # dependabot-auto-merge:
  #   name: Auto-merge Dependabot PRs
  #   runs-on: ubuntu-latest
  #   needs: [build-check]
  #   if: github.actor == 'dependabot[bot]' && github.event_name == 'pull_request'
  #   steps:
  #     - name: Enable auto-merge
  #       run: gh pr merge --auto --squash "$PR_URL"
  #       env:
  #         PR_URL: ${{github.event.pull_request.html_url}}
  #         GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}